<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Favourites</title>
    <link rel="stylesheet" th:href="@{/styles.css}"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

<div class="navbar">
    <div class="navInner">
        <div class="brand">
            <div class="brandTitle">Rendyho databáze</div>
            <div class="brandBig">FAVOURITES</div>
        </div>

        <div class="navRight">
            <div class="navUser" th:text="${username}">user</div>
            <a class="btn btnGhost" th:href="@{/index(username=${username})}">Back to search</a>
            <a class="btn btnGhost" th:href="@{/login}">Sign out</a>
        </div>
    </div>
</div>

<div class="container">

    <div class="hero">
        <div class="heroTitle">Your favourites</div>
        <div class="heroSub">Saved movies for this account.</div>
    </div>

    <div class="tableWrap">
        <table>
            <thead>
            <tr>
                <th style="width:90px;">Poster</th>
                <th>Title</th>
                <th style="width:90px;">Year</th>
                <th style="width:170px;"></th>
            </tr>
            </thead>

            <tbody>

            <tr th:if="${#lists.isEmpty(myMovies)}">
                <td colspan="4" class="small">No favourites yet.</td>
            </tr>

            <tr class="rowHover"
                th:each="um : ${myMovies}"
                th:attr="data-rowid=${um.id}">
                <td>
                    <img class="poster"
                         th:if="${um != null and um.movie != null and um.movie.posterUrl != null and um.movie.posterUrl != 'N/A'}"
                         th:src="${um.movie.posterUrl}" alt="poster">

                    <div class="small"
                         th:if="${um == null or um.movie == null or um.movie.posterUrl == null or um.movie.posterUrl == 'N/A'}"
                         style="width:64px; height:96px; display:flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,.10); border-radius:14px;">
                        —
                    </div>
                </td>

                <td style="font-weight:1000;">
                    <a th:href="@{/movie(username=${username}, imdbId=${um.movie.imdbId})}"
                       style="color:inherit; text-decoration:none;">
                        <span th:text="${um.movie.title}">Title</span>
                    </a>

                    <div></div>

                    <!-- ✅ žádné id, title bereme z tohohle konkrétního buttonu -->
                    <button class="btn btnRedWTDetail"
                            type="button"
                            th:attr="data-title=${um.movie.title}"
                            onclick="openTrailer(this)">
                        Watch trailer
                    </button>
                </td>

                <td style="font-weight:900;" th:text="${um.movie.year}">Year</td>

                <td>
                    <button class="btn btnRed btnBlock"
                            type="button"
                            th:attr="data-umid=${um.id}"
                            onclick="deleteFav(this)">
                        Remove
                    </button>
                </td>
            </tr>

            </tbody>
        </table>
    </div>

</div>

<div id="toast" class="toast">
    <span class="toastDot"></span>
    <span id="toastText">Done</span>
</div>

<div id="trailerModal" class="modal" style="display:none;">
    <div class="modalBackdrop" onclick="closeTrailer()"></div>

    <div class="modalCard">
        <div class="modalTop">
            <div class="modalTitle">Trailer</div>
            <button class="btn btnGhost" type="button" onclick="closeTrailer()">Close</button>
        </div>

        <div class="modalBody">
            <iframe id="trailerFrame"
                    width="100%" height="420"
                    style="border:0; border-radius:16px;"
                    allow="autoplay; encrypted-media"
                    allowfullscreen></iframe>

            <div id="trailerEmpty" class="small" style="display:none; margin-top:12px;">
                Trailer not found.
            </div>
        </div>
    </div>
</div>

<script>
    function showToast(text){
      const t = document.getElementById("toast");
      const tt = document.getElementById("toastText");
      tt.textContent = text;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 1600);
    }

    function deleteFav(btn){
      const userMovieId = btn.dataset.umid;
      btn.disabled = true;
      btn.textContent = "Removing…";

      fetch("/favourites/delete", {
        method: "POST",
        headers: {"Content-Type":"application/x-www-form-urlencoded"},
        body: new URLSearchParams({
          username: "[[${username}]]",
          userMovieId: userMovieId
        })
      })
      .then(res => {
        if(res.ok){
          const tr = btn.closest("tr");
          if(tr) tr.remove();
          showToast("Removed from favourites");
        } else {
          btn.disabled = false;
          btn.textContent = "Remove";
          showToast("Failed");
        }
      })
      .catch(() => {
        btn.disabled = false;
        btn.textContent = "Remove";
        showToast("Failed");
      });
    }
</script>

<script>
    // ✅ bere title z buttonu, na který klikneš
    function openTrailer(btn){
      const title = (btn?.dataset?.title || "").trim();

      const modal = document.getElementById("trailerModal");
      const frame = document.getElementById("trailerFrame");
      const empty = document.getElementById("trailerEmpty");

      modal.style.display = "block";
      empty.style.display = "none";
      frame.src = ""; // reset

      fetch("/api/trailer?title=" + encodeURIComponent(title))
        .then(r => r.json())
        .then(data => {
          if(data && data.videoId){
            frame.src = "https://www.youtube.com/embed/" + data.videoId + "?autoplay=1";
          } else {
            empty.style.display = "block";
          }
        })
        .catch(() => {
          empty.style.display = "block";
        });
    }

    function closeTrailer(){
      const modal = document.getElementById("trailerModal");
      const frame = document.getElementById("trailerFrame");
      frame.src = ""; // stop playback
      modal.style.display = "none";
    }
</script>

</body>
</html>